{% extends "base.html" %}

{% block title %}Добавить хадис - Админ-панель{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-plus-circle"></i> Новый хадис</span>
            </div>
            <div class="card-body">
                <form method="post" action="/hadiths/add">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="book" class="form-label fw-bold">Книга</label>
                            <select class="form-select" id="book" name="book" required>
                                {% for key, names in books.items() %}
                                <option value="{{ key }}">{{ names.ru }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="language" class="form-label fw-bold">Язык</label>
                            <select class="form-select" id="language" name="language" required>
                                <option value="ru">Русский</option>
                                <option value="en">English</option>
                                <option value="ar">العربية (Arabic)</option>
                                <option value="tr">Türkçe (Turkish)</option>
                                <option value="fr">Français (French)</option>
                                <option value="bn">বাংলা (Bengali)</option>
                                <option value="id">Bahasa Indonesia</option>
                                <option value="ta">தமிழ் (Tamil)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Текст хадиса</label>
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="editor-tab" data-bs-toggle="tab" data-bs-target="#editor" type="button" role="tab">Редактор</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" onclick="updatePreview()">Предпросмотр</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content border border-top-0 p-3 rounded-bottom bg-white" id="myTabContent">
                            <div class="tab-pane fade show active" id="editor" role="tabpanel">
                                <div class="btn-toolbar mb-2" role="toolbar">
                                    <div class="btn-group me-2 mb-1" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'b')" title="Жирный"><b>B</b></button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'i')" title="Курсив"><i>I</i></button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'u')" title="Подчеркнутый"><u>U</u></button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 's')" title="Зачеркнутый"><s>S</s></button>
                                    </div>
                                    <div class="btn-group me-2 mb-1" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'a')" title="Ссылка"><i class="fas fa-link"></i></button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'code')" title="Код (строка)"><i class="fas fa-code"></i></button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'pre')" title="Код (блок)"><i class="fas fa-file-code"></i></button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'spoiler')" title="Скрытый текст (спойлер)"><i class="fas fa-eye-slash"></i></button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHtmlTag('text', 'blockquote')" title="Цитата"><i class="fas fa-quote-right"></i></button>
                                    </div>
                                </div>
                                <textarea class="form-control font-monospace" id="text" name="text" rows="12" required placeholder="Введите текст хадиса... Не забудьте 'Номер хадиса: 123'"></textarea>
                            </div>
                            
                            <div class="tab-pane fade" id="preview" role="tabpanel">
                                <div class="p-3 bg-light rounded border">
                                    <div id="preview-content" style="white-space: pre-wrap;"></div>
                                </div>
                                <small class="text-muted mt-2 d-block"><i class="fas fa-info-circle"></i> Так сообщение примерно будет выглядеть в Telegram.</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="/hadiths" class="btn btn-secondary">Отмена</a>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card bg-light border-0">
            <div class="card-body">
                <h6 class="fw-bold text-muted text-uppercase mb-3">Последний добавленный</h6>
                <div id="last-hadith-content">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm mb-2"></div>
                        <div>Загрузка...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updatePreview() {
    const text = document.getElementById('text').value;
    
    if (!text) {
        document.getElementById('preview-content').innerHTML = '<span class="text-muted">Текст пуст...</span>';
        return;
    }

    // 1. Сначала экранируем спецсимволы, чтобы обычный текст не стал HTML-кодом случайно
    let escaped = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");

    // 2. Восстанавливаем разрешенные HTML теги Telegram для предпросмотра
    // Используем регулярные выражения с флагом 'g' (глобально) и 'i' (без учета регистра)
    let previewHtml = escaped
        // Жирный
        .replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/gi, "<b>$1</b>")
        .replace(/&lt;strong&gt;(.*?)&lt;\/strong&gt;/gi, "<strong>$1</strong>")
        // Курсив
        .replace(/&lt;i&gt;(.*?)&lt;\/i&gt;/gi, "<i>$1</i>")
        .replace(/&lt;em&gt;(.*?)&lt;\/em&gt;/gi, "<em>$1</em>")
        // Подчеркнутый и зачеркнутый
        .replace(/&lt;u&gt;(.*?)&lt;\/u&gt;/gi, "<u>$1</u>")
        .replace(/&lt;ins&gt;(.*?)&lt;\/ins&gt;/gi, "<ins>$1</ins>")
        .replace(/&lt;s&gt;(.*?)&lt;\/s&gt;/gi, "<s>$1</s>")
        .replace(/&lt;strike&gt;(.*?)&lt;\/strike&gt;/gi, "<strike>$1</strike>")
        .replace(/&lt;del&gt;(.*?)&lt;\/del&gt;/gi, "<del>$1</del>")
        // Код
        .replace(/&lt;code&gt;(.*?)&lt;\/code&gt;/gi, "<code>$1</code>")
        .replace(/&lt;pre&gt;(.*?)&lt;\/pre&gt;/gi, "<pre>$1</pre>")
        // Цитата
        .replace(/&lt;blockquote&gt;(.*?)&lt;\/blockquote&gt;/gi, "<blockquote>$1</blockquote>")
        // Ссылка (простой парсинг href)
        .replace(/&lt;a href=&quot;(.*?)&quot;&gt;(.*?)&lt;\/a&gt;/gi, '<a href="$1" target="_blank">$2</a>')
        // Спойлер (эмуляция через размытый span)
        .replace(/&lt;tg-spoiler&gt;(.*?)&lt;\/tg-spoiler&gt;/gi, '<span style="filter: blur(5px); cursor: pointer; background-color: #ccc; color: transparent; user-select: none;" onclick="this.style.filter=\'none\'; this.style.color=\'inherit\'; this.style.backgroundColor=\'transparent\';" title="Нажмите, чтобы увидеть">$1</span>');

    document.getElementById('preview-content').innerHTML = previewHtml;
}

async function loadLastHadith() {
    const book = document.getElementById('book').value;
    const language = document.getElementById('language').value;
    const contentDiv = document.getElementById('last-hadith-content');
    
    try {
        const response = await fetch(`/api/last-hadith?book=${book}&language=${language}`);
        const data = await response.json();
        if (data.success) {
            // FIX: Безопасная вставка текста хадиса через textContent
            contentDiv.innerHTML = `
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="badge bg-success mb-2">#${data.hadith.hadith_number || '?'}</div>
                        <small class="d-block text-muted text-truncate" style="max-height: 100px; overflow:hidden;" id="last-hadith-text-safe"></small>
                    </div>
                </div>`;
            document.getElementById('last-hadith-text-safe').textContent = data.hadith.text;
        } else {
            contentDiv.innerHTML = `<div class="alert alert-info small">${data.message}</div>`;
        }
    } catch (e) {
        contentDiv.innerHTML = `<div class="text-danger small">Ошибка загрузки</div>`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadLastHadith();
    document.getElementById('book').addEventListener('change', loadLastHadith);
    document.getElementById('language').addEventListener('change', loadLastHadith);
});
</script>
{% endblock %}